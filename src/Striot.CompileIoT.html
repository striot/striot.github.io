<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -F -pgmF htfpp #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Striot.CompileIoT</span><span> </span><span class="hs-special">(</span><span> </span><a href="Striot.CompileIoT.html#createPartitions"><span class="hs-identifier hs-var">createPartitions</span></a><span>
</span><a name="line-5"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#generateCode"><span class="hs-identifier hs-var">generateCode</span></a><span>
</span><a name="line-6"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier hs-type">GenerateOpts</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-7"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#defaultOpts"><span class="hs-identifier hs-var">defaultOpts</span></a><span>
</span><a name="line-8"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#PartitionMap"><span class="hs-identifier hs-type">PartitionMap</span></a><span>
</span><a name="line-9"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#writePart"><span class="hs-identifier hs-var">writePart</span></a><span>
</span><a name="line-10"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#genDockerfile"><span class="hs-identifier hs-var">genDockerfile</span></a><span>
</span><a name="line-11"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#partitionGraph"><span class="hs-identifier hs-var">partitionGraph</span></a><span>
</span><a name="line-12"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#simpleStream"><span class="hs-identifier hs-var">simpleStream</span></a><span>
</span><a name="line-13"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#optimiseWriteOutAll"><span class="hs-identifier hs-var">optimiseWriteOutAll</span></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.LogicalOptimiser.html#optimise"><span class="hs-identifier hs-var">optimise</span></a><span>
</span><a name="line-16"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#generateCodeFromStreamGraph"><span class="hs-identifier hs-var">generateCodeFromStreamGraph</span></a><span>
</span><a name="line-17"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#nodeFn"><span class="hs-identifier hs-var">nodeFn</span></a><span>
</span><a name="line-18"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#nodeType"><span class="hs-identifier hs-var">nodeType</span></a><span>
</span><a name="line-19"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#generateNodeSrc"><span class="hs-identifier hs-var">generateNodeSrc</span></a><span>
</span><a name="line-20"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#connectNodeId"><span class="hs-identifier hs-var">connectNodeId</span></a><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#allOptimisations"><span class="hs-identifier hs-var">allOptimisations</span></a><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#htf_Striot_CompileIoT_thisModulesTests"><span class="hs-identifier hs-var">htf_thisModulesTests</span></a><span>
</span><a name="line-25"></a><span>                         </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nub</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Algebra.Graph</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Algebra.Graph.ToGraph</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reachable</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Test.Framework</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;/&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nub</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List.Match</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">compareLength</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Striot.StreamGraph.html"><span class="hs-identifier">Striot.StreamGraph</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Striot.LogicalOptimiser.html"><span class="hs-identifier">Striot.LogicalOptimiser</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Striot.Jackson.html"><span class="hs-identifier">Striot.Jackson</span></a><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- StreamGraph Partitioning</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-comment">-- |eventually, this might include properties about the partition (Catalogue).</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- For now we just need a way of enumerating them.</span><span>
</span><a name="line-48"></a><span class="hs-keyword">type</span><span> </span><a name="Partition"><a href="Striot.CompileIoT.html#Partition"><span class="hs-identifier">Partition</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-comment">-- |The user's desired partitioning of the input Graph.</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- Each element in the outer-most list corresponds to a distinct partition.</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- The inner-lists are the IDs of Operators to include in that partition.</span><span>
</span><a name="line-53"></a><span class="hs-keyword">type</span><span> </span><a name="PartitionMap"><a href="Striot.CompileIoT.html#PartitionMap"><span class="hs-identifier">PartitionMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">-- createPartitions returns ([partition map], [inter-graph links])</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- where inter-graph links are the cut edges due to partitioning</span><span>
</span><a name="line-57"></a><span class="hs-identifier">createPartitions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#PartitionMap"><span class="hs-identifier hs-type">PartitionMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.StreamGraph.html#PartitionedGraph"><span class="hs-identifier hs-type">PartitionedGraph</span></a><span>
</span><a name="line-58"></a><a name="createPartitions"><a href="Striot.CompileIoT.html#createPartitions"><span class="hs-identifier">createPartitions</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-identifier">createPartitions</span><span> </span><a name="local-6989586621679325873"><a href="#local-6989586621679325873"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679325874"><a href="#local-6989586621679325874"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679325875"><a href="#local-6989586621679325875"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325879"><span class="hs-identifier hs-var">thisGraph</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679325882"><span class="hs-identifier hs-var">tailParts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679325881"><span class="hs-identifier hs-var">edgesOut</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">overlay</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679325883"><span class="hs-identifier hs-var">tailCuts</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-60"></a><span>    </span><a name="local-6989586621679325876"><a href="#local-6989586621679325876"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621679325884"><a href="#local-6989586621679325884"><span class="hs-identifier">v</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">vertexId</span><span> </span><a href="#local-6989586621679325884"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679325874"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-61"></a><span>    </span><a name="local-6989586621679325877"><a href="#local-6989586621679325877"><span class="hs-identifier">vs</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vertices</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679325876"><span class="hs-identifier hs-var">fv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679325873"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>    </span><a name="local-6989586621679325878"><a href="#local-6989586621679325878"><span class="hs-identifier">es</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">edges</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679325885"><a href="#local-6989586621679325885"><span class="hs-identifier">v1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325886"><a href="#local-6989586621679325886"><span class="hs-identifier">v2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325876"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621679325885"><span class="hs-identifier hs-var">v1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325876"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621679325886"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">edgeList</span><span> </span><a href="#local-6989586621679325873"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>    </span><a name="local-6989586621679325879"><a href="#local-6989586621679325879"><span class="hs-identifier">thisGraph</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">overlay</span><span> </span><a href="#local-6989586621679325877"><span class="hs-identifier hs-var">vs</span></a><span> </span><a href="#local-6989586621679325878"><span class="hs-identifier hs-var">es</span></a><span>
</span><a name="line-64"></a><span>    </span><a name="local-6989586621679325880"><a href="#local-6989586621679325880"><span class="hs-identifier">stripMerge</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#mkStripMerge"><span class="hs-identifier hs-var">mkStripMerge</span></a><span> </span><a href="#local-6989586621679325879"><span class="hs-identifier hs-var">thisGraph</span></a><span> </span><a href="#local-6989586621679325873"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-65"></a><span>    </span><a name="local-6989586621679325881"><a href="#local-6989586621679325881"><span class="hs-identifier">edgesOut</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">edges</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679325887"><a href="#local-6989586621679325887"><span class="hs-identifier">v1</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325888"><a href="#local-6989586621679325888"><span class="hs-identifier">v2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325876"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621679325887"><span class="hs-identifier hs-var">v1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span class="hs-special">(</span><a href="#local-6989586621679325876"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621679325888"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">edgeList</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325880"><span class="hs-identifier hs-var">stripMerge</span></a><span> </span><a href="#local-6989586621679325873"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679325882"><a href="#local-6989586621679325882"><span class="hs-identifier">tailParts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679325883"><a href="#local-6989586621679325883"><span class="hs-identifier">tailCuts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#createPartitions"><span class="hs-identifier hs-var">createPartitions</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325880"><span class="hs-identifier hs-var">stripMerge</span></a><span> </span><a href="#local-6989586621679325873"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325875"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- | Builds a function to remove Merges from a StreamGraph, if they are</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- connected to from operators in another (local) graph. We remove Merges</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- from the beginning of Partitions and use the TCP/IP machinery to merge</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- multiple incoming streams instead.</span><span>
</span><a name="line-72"></a><span class="hs-identifier">mkStripMerge</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><a name="mkStripMerge"><a href="Striot.CompileIoT.html#mkStripMerge"><span class="hs-identifier">mkStripMerge</span></a></a><span> </span><a name="local-6989586621679325889"><a href="#local-6989586621679325889"><span class="hs-identifier">local</span></a></a><span> </span><a name="local-6989586621679325890"><a href="#local-6989586621679325890"><span class="hs-identifier">global</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">-- find Merges in global Graph connected to from local Graph</span><span>
</span><a name="line-75"></a><span>    </span><a name="local-6989586621679325891"><a href="#local-6989586621679325891"><span class="hs-identifier">merges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span>
</span><a name="line-76"></a><span>           </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679325893"><a href="#local-6989586621679325893"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325894"><a href="#local-6989586621679325894"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325893"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679325889"><span class="hs-identifier hs-var">local</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">operator</span><span> </span><a href="#local-6989586621679325894"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Striot.StreamGraph.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>           </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">edgeList</span><span> </span><a href="#local-6989586621679325890"><span class="hs-identifier hs-var">global</span></a><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>    </span><a name="local-6989586621679325892"><a href="#local-6989586621679325892"><span class="hs-identifier">remove</span></a></a><span> </span><a name="local-6989586621679325895"><a href="#local-6989586621679325895"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679325896"><a href="#local-6989586621679325896"><span class="hs-identifier">nextOp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><a href="#local-6989586621679325895"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">edgeList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679325890"><span class="hs-identifier hs-var">global</span></a><span>
</span><a name="line-80"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">removeEdge</span><span> </span><a href="#local-6989586621679325896"><span class="hs-identifier hs-var">nextOp</span></a><span> </span><a href="#local-6989586621679325896"><span class="hs-identifier hs-var">nextOp</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">replaceVertex</span><span> </span><a href="#local-6989586621679325895"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679325896"><span class="hs-identifier hs-var">nextOp</span></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679325897"><a href="#local-6989586621679325897"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325897"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679325892"><span class="hs-identifier hs-var">remove</span></a><span> </span><a href="#local-6989586621679325891"><span class="hs-identifier hs-var">merges</span></a><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><a name="global"><a href="Striot.CompileIoT.html#global"><span class="hs-identifier">global</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">path</span><span>
</span><a name="line-85"></a><span>    </span><span class="hs-special">[</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-86"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="Striot.StreamGraph.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="Striot.StreamGraph.html#Map"><span class="hs-identifier hs-var">Map</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-88"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">3</span><span> </span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-identifier hs-var">print</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-90"></a><a name="local"><a href="Striot.CompileIoT.html#local"><span class="hs-identifier">local</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Vertex</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><a name="stripMergePost"><a href="Striot.CompileIoT.html#stripMergePost"><span class="hs-identifier">stripMergePost</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">path</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-special">[</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="Striot.StreamGraph.html#Map"><span class="hs-identifier hs-var">Map</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">3</span><span> </span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-identifier hs-var">print</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><a name="test_stripMerge1"><a href="Striot.CompileIoT.html#test_stripMerge1"><span class="hs-identifier">test_stripMerge1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-identifier">stripMergePost</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-99"></a><span>    </span><a href="Striot.CompileIoT.html#mkStripMerge"><span class="hs-identifier hs-var">mkStripMerge</span></a><span> </span><a href="Striot.CompileIoT.html#local"><span class="hs-identifier hs-var">local</span></a><span> </span><a href="Striot.CompileIoT.html#global"><span class="hs-identifier hs-var">global</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.CompileIoT.html#global"><span class="hs-identifier hs-var">global</span></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><a name="test_stripMerge2"><a href="Striot.CompileIoT.html#test_stripMerge2"><span class="hs-identifier">test_stripMerge2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-identifier">stripMergePost</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-102"></a><span>    </span><a href="Striot.CompileIoT.html#mkStripMerge"><span class="hs-identifier hs-var">mkStripMerge</span></a><span> </span><a href="Striot.CompileIoT.html#local"><span class="hs-identifier hs-var">local</span></a><span> </span><a href="Striot.CompileIoT.html#stripMergePost"><span class="hs-identifier hs-var">stripMergePost</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.CompileIoT.html#stripMergePost"><span class="hs-identifier hs-var">stripMergePost</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-identifier">unPartition</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#PartitionedGraph"><span class="hs-identifier hs-type">PartitionedGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-type">StreamVertex</span></a><span>
</span><a name="line-105"></a><a name="unPartition"><a href="Striot.CompileIoT.html#unPartition"><span class="hs-identifier">unPartition</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679325898"><a href="#local-6989586621679325898"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325899"><a href="#local-6989586621679325899"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">overlay</span><span> </span><a href="#local-6989586621679325899"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-identifier hs-var">overlay</span><span> </span><span class="hs-identifier hs-var">Empty</span><span> </span><a href="#local-6989586621679325898"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- Code generation from StreamGraph definitions</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">{-
    a well-formed streamgraph:
        always starts with a Source?
        always ends with a Sink?
        always has just one Sink?
        is entirely connected?
        ...
    a well-formed partition spec:
        has &gt;= 1 partition
        references node IDs that exist
        covers all node IDs?
        passes some kind of connectedness test?
-}</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-keyword">data</span><span> </span><a name="GenerateOpts"><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier">GenerateOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="GenerateOpts"><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier">GenerateOpts</span></a></a><span>
</span><a name="line-125"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="imports"><a href="Striot.CompileIoT.html#imports"><span class="hs-identifier">imports</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- list of import statements to add to generated files</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="packages"><a href="Striot.CompileIoT.html#packages"><span class="hs-identifier">packages</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- list of Cabal packages to install within containers</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="preSource"><a href="Striot.CompileIoT.html#preSource"><span class="hs-identifier">preSource</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- code to run prior to starting nodeSource</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="rewrite"><a href="Striot.CompileIoT.html#rewrite"><span class="hs-identifier">rewrite</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>         </span><span class="hs-comment">-- should each partition be logically optimised?</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><a name="defaultOpts"><a href="Striot.CompileIoT.html#defaultOpts"><span class="hs-identifier">defaultOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier hs-var">GenerateOpts</span></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">imports</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;Striot.FunctionalIoTtypes&quot;</span><span>
</span><a name="line-133"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Striot.FunctionalProcessing&quot;</span><span>
</span><a name="line-134"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Striot.Nodes&quot;</span><span>
</span><a name="line-135"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Control.Concurrent&quot;</span><span>
</span><a name="line-136"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Control.Category ((&gt;&gt;&gt;))&quot;</span><span> </span><span class="hs-comment">-- (generated by rewrites)</span><span>
</span><a name="line-137"></a><span>                  </span><span class="hs-special">]</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">packages</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-139"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">preSource</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-140"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rewrite</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- |Partitions the supplied `StreamGraph` according to the supplied `PartitionMap`</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- and options specified within the supplied `GenerateOpts` and returns a list of</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- the sub-graphs converted into source code and encoded as `String`s.</span><span>
</span><a name="line-146"></a><span class="hs-identifier">generateCode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#PartitionMap"><span class="hs-identifier hs-type">PartitionMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier hs-type">GenerateOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-147"></a><a name="generateCode"><a href="Striot.CompileIoT.html#generateCode"><span class="hs-identifier">generateCode</span></a></a><span> </span><a name="local-6989586621679325900"><a href="#local-6989586621679325900"><span class="hs-identifier">sg</span></a></a><span> </span><a name="local-6989586621679325901"><a href="#local-6989586621679325901"><span class="hs-identifier">pm</span></a></a><span> </span><a name="local-6989586621679325902"><a href="#local-6989586621679325902"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679325903"><a href="#local-6989586621679325903"><span class="hs-identifier">sgs</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325904"><a href="#local-6989586621679325904"><span class="hs-identifier">cuts</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#createPartitions"><span class="hs-identifier hs-var">createPartitions</span></a><span> </span><a href="#local-6989586621679325900"><span class="hs-identifier hs-var">sg</span></a><span> </span><a href="#local-6989586621679325901"><span class="hs-identifier hs-var">pm</span></a><span>
</span><a name="line-149"></a><span>    </span><a name="local-6989586621679325905"><a href="#local-6989586621679325905"><span class="hs-identifier">sgs'</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">rewrite</span><span> </span><a href="#local-6989586621679325902"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Striot.LogicalOptimiser.html#optimise"><span class="hs-identifier hs-var">optimise</span></a><span> </span><a href="#local-6989586621679325903"><span class="hs-identifier hs-var">sgs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679325903"><span class="hs-identifier hs-var">sgs</span></a><span>
</span><a name="line-150"></a><span>    </span><a name="local-6989586621679325906"><a href="#local-6989586621679325906"><span class="hs-identifier">enumeratedParts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679325905"><span class="hs-identifier hs-var">sgs'</span></a><span>
</span><a name="line-151"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#generateCodeFromStreamGraph"><span class="hs-identifier hs-var">generateCodeFromStreamGraph</span></a><span> </span><a href="#local-6989586621679325902"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679325906"><span class="hs-identifier hs-var">enumeratedParts</span></a><span> </span><a href="#local-6989586621679325904"><span class="hs-identifier hs-var">cuts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325906"><span class="hs-identifier hs-var">enumeratedParts</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-keyword">data</span><span> </span><a name="NodeType"><a href="Striot.CompileIoT.html#NodeType"><span class="hs-identifier">NodeType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NodeSource"><a href="Striot.CompileIoT.html#NodeSource"><span class="hs-identifier">NodeSource</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="NodeSink"><a href="Striot.CompileIoT.html#NodeSink"><span class="hs-identifier">NodeSink</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="NodeLink"><a href="Striot.CompileIoT.html#NodeLink"><span class="hs-identifier">NodeLink</span></a></a><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-identifier">nodeType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#NodeType"><span class="hs-identifier hs-type">NodeType</span></a><span>
</span><a name="line-156"></a><a name="nodeType"><a href="Striot.CompileIoT.html#nodeType"><span class="hs-identifier">nodeType</span></a></a><span> </span><a name="local-6989586621679325907"><a href="#local-6989586621679325907"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Striot.StreamGraph.html#isSource"><span class="hs-identifier hs-var">isSource</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">operator</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679325907"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>              </span><span class="hs-keyword">then</span><span> </span><a href="Striot.CompileIoT.html#NodeSource"><span class="hs-identifier hs-var">NodeSource</span></a><span>
</span><a name="line-158"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">operator</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">head</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">reverse</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">vertexList</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325907"><span class="hs-identifier hs-var">sg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span>
</span><a name="line-159"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><a href="Striot.CompileIoT.html#NodeSink"><span class="hs-identifier hs-var">NodeSink</span></a><span>
</span><a name="line-160"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><a href="Striot.CompileIoT.html#NodeLink"><span class="hs-identifier hs-var">NodeLink</span></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-comment">-- vertexList outputs *sorted* (By Ord a =&gt;). That corresponds to the Id value for</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- our StreamVertex type</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- TODO consider Difference Lists here</span><span>
</span><a name="line-167"></a><span class="hs-identifier">generateCodeFromStreamGraph</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier hs-type">GenerateOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">,</span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-168"></a><a name="generateCodeFromStreamGraph"><a href="Striot.CompileIoT.html#generateCodeFromStreamGraph"><span class="hs-identifier">generateCodeFromStreamGraph</span></a></a><span> </span><a name="local-6989586621679325908"><a href="#local-6989586621679325908"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679325909"><a href="#local-6989586621679325909"><span class="hs-identifier">parts</span></a></a><span> </span><a name="local-6989586621679325910"><a href="#local-6989586621679325910"><span class="hs-identifier">cuts</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679325911"><a href="#local-6989586621679325911"><span class="hs-identifier">partId</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325912"><a href="#local-6989586621679325912"><span class="hs-identifier">sg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-169"></a><span>    </span><a href="#local-6989586621679325913"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-comment">-- convenience comment labelling the node/partition ID</span><span>
</span><a name="line-170"></a><span>    </span><a href="#local-6989586621679325920"><span class="hs-identifier hs-var">imports'</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-171"></a><span>    </span><a href="Striot.CompileIoT.html#possibleSrcFn"><span class="hs-identifier hs-var">possibleSrcFn</span></a><span> </span><a href="#local-6989586621679325909"><span class="hs-identifier hs-var">parts</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-172"></a><span>    </span><a href="Striot.CompileIoT.html#possibleSinkFn"><span class="hs-identifier hs-var">possibleSinkFn</span></a><span> </span><a href="#local-6989586621679325909"><span class="hs-identifier hs-var">parts</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-173"></a><span>    </span><a href="#local-6989586621679325916"><span class="hs-identifier hs-var">sgTypeSignature</span></a><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-174"></a><span>    </span><a href="#local-6989586621679325917"><span class="hs-identifier hs-var">sgIntro</span></a><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-175"></a><span>    </span><a href="#local-6989586621679325919"><span class="hs-identifier hs-var">sgBody</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-special">[</span><a href="#local-6989586621679325914"><span class="hs-identifier hs-var">padding</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;in &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679325921"><span class="hs-identifier hs-var">lastIdentifier</span></a><span class="hs-special">,</span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-string">&quot;main :: IO ()&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-178"></a><span>    </span><a href="Striot.CompileIoT.html#nodeFn"><span class="hs-identifier hs-var">nodeFn</span></a><span> </span><a href="#local-6989586621679325909"><span class="hs-identifier hs-var">parts</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span> </span><a href="#local-6989586621679325911"><span class="hs-identifier hs-var">partId</span></a><span> </span><a href="#local-6989586621679325910"><span class="hs-identifier hs-var">cuts</span></a><span> </span><a href="#local-6989586621679325908"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>        </span><a name="local-6989586621679325913"><a href="#local-6989586621679325913"><span class="hs-identifier">nodeId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;-- node&quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679325911"><span class="hs-identifier hs-var">partId</span></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>        </span><a name="local-6989586621679325914"><a href="#local-6989586621679325914"><span class="hs-identifier">padding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;    &quot;</span><span>
</span><a name="line-182"></a><span>        </span><a name="local-6989586621679325915"><a href="#local-6989586621679325915"><span class="hs-identifier">pad</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325914"><span class="hs-identifier hs-var">padding</span></a><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span>        </span><a name="local-6989586621679325916"><a href="#local-6989586621679325916"><span class="hs-identifier">sgTypeSignature</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Striot.CompileIoT.html#startsWithJoin"><span class="hs-identifier hs-var">startsWithJoin</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-185"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;streamGraphFn ::&quot;</span><span>
</span><a name="line-186"></a><span>                    </span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; Stream &quot;</span><span class="hs-operator hs-var">++</span><a href="Striot.CompileIoT.html#inType"><span class="hs-identifier hs-var">inType</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; -&gt;&quot;</span><span>
</span><a name="line-187"></a><span>                    </span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; Stream &quot;</span><span class="hs-operator hs-var">++</span><a href="Striot.CompileIoT.html#inType"><span class="hs-identifier hs-var">inType</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; -&gt;&quot;</span><span>
</span><a name="line-188"></a><span>                    </span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; Stream &quot;</span><span class="hs-operator hs-var">++</span><a href="Striot.CompileIoT.html#outType"><span class="hs-identifier hs-var">outType</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-189"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;streamGraphFn ::&quot;</span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; Stream &quot;</span><span class="hs-operator hs-var">++</span><a href="Striot.CompileIoT.html#inType"><span class="hs-identifier hs-var">inType</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; -&gt;&quot;</span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; Stream &quot;</span><span class="hs-operator hs-var">++</span><a href="Striot.CompileIoT.html#outType"><span class="hs-identifier hs-var">outType</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span>        </span><a name="local-6989586621679325917"><a href="#local-6989586621679325917"><span class="hs-identifier">sgIntro</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;streamGraphFn &quot;</span><span class="hs-operator hs-var">++</span><a href="#local-6989586621679325918"><span class="hs-identifier hs-var">sgArgs</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; = let&quot;</span><span>
</span><a name="line-192"></a><span>        </span><a name="local-6989586621679325918"><a href="#local-6989586621679325918"><span class="hs-identifier">sgArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Striot.CompileIoT.html#startsWithJoin"><span class="hs-identifier hs-var">startsWithJoin</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-193"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;n1 n2&quot;</span><span>
</span><a name="line-194"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;n1&quot;</span><span>
</span><a name="line-195"></a><span>        </span><a name="local-6989586621679325919"><a href="#local-6989586621679325919"><span class="hs-identifier">sgBody</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679325915"><span class="hs-identifier hs-var">pad</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679325923"><span class="hs-identifier hs-var">valence</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679325922"><span class="hs-identifier hs-var">intVerts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-196"></a><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;n2 = n1&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-197"></a><span>            </span><a name="local-6989586621679325924"><a href="#local-6989586621679325924"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Striot.CompileIoT.html#generateCodeFromVertex"><span class="hs-identifier hs-var">generateCodeFromVertex</span></a><span> </span><a href="#local-6989586621679325924"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-198"></a><span>        </span><a name="local-6989586621679325920"><a href="#local-6989586621679325920"><span class="hs-identifier">imports'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;import &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imports</span><span> </span><a href="#local-6989586621679325908"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-199"></a><span>        </span><a name="local-6989586621679325921"><a href="#local-6989586621679325921"><span class="hs-identifier">lastIdentifier</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'n'</span><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679325922"><span class="hs-identifier hs-var">intVerts</span></a><span>
</span><a name="line-200"></a><span>            </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Striot.CompileIoT.html#startsWithJoin"><span class="hs-identifier hs-var">startsWithJoin</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>        </span><a name="local-6989586621679325922"><a href="#local-6989586621679325922"><span class="hs-identifier">intVerts</span></a></a><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Striot.CompileIoT.html#singleton"><span class="hs-identifier hs-var">singleton</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-202"></a><span>        </span><a name="local-6989586621679325923"><a href="#local-6989586621679325923"><span class="hs-identifier">valence</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#partValence"><span class="hs-identifier hs-var">partValence</span></a><span> </span><a href="#local-6989586621679325912"><span class="hs-identifier hs-var">sg</span></a><span> </span><a href="#local-6989586621679325910"><span class="hs-identifier hs-var">cuts</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><a name="nodeFn"><a href="Striot.CompileIoT.html#nodeFn"><span class="hs-identifier">nodeFn</span></a></a><span> </span><a name="local-6989586621679325925"><a href="#local-6989586621679325925"><span class="hs-identifier">parts</span></a></a><span> </span><a name="local-6989586621679325926"><a href="#local-6989586621679325926"><span class="hs-identifier">sg</span></a></a><span> </span><a name="local-6989586621679325927"><a href="#local-6989586621679325927"><span class="hs-identifier">partId</span></a></a><span> </span><a name="local-6989586621679325928"><a href="#local-6989586621679325928"><span class="hs-identifier">cuts</span></a></a><span> </span><a name="local-6989586621679325929"><a href="#local-6989586621679325929"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-205"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679325925"><span class="hs-identifier hs-var">parts</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;main = nodeSimple src1 streamGraphFn sink1&quot;</span><span>
</span><a name="line-207"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#nodeType"><span class="hs-identifier hs-var">nodeType</span></a><span> </span><a href="#local-6989586621679325926"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-208"></a><span>        </span><a href="Striot.CompileIoT.html#NodeSource"><span class="hs-identifier hs-var">NodeSource</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#generateNodeSrc"><span class="hs-identifier hs-var">generateNodeSrc</span></a><span> </span><a href="#local-6989586621679325927"><span class="hs-identifier hs-var">partId</span></a><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#connectNodeId"><span class="hs-identifier hs-var">connectNodeId</span></a><span> </span><a href="#local-6989586621679325926"><span class="hs-identifier hs-var">sg</span></a><span> </span><a href="#local-6989586621679325925"><span class="hs-identifier hs-var">parts</span></a><span> </span><a href="#local-6989586621679325928"><span class="hs-identifier hs-var">cuts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325929"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679325925"><span class="hs-identifier hs-var">parts</span></a><span>
</span><a name="line-209"></a><span>        </span><a href="Striot.CompileIoT.html#NodeLink"><span class="hs-identifier hs-var">NodeLink</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#generateNodeLink"><span class="hs-identifier hs-var">generateNodeLink</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325927"><span class="hs-identifier hs-var">partId</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>        </span><a href="Striot.CompileIoT.html#NodeSink"><span class="hs-identifier hs-var">NodeSink</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#generateNodeSink"><span class="hs-identifier hs-var">generateNodeSink</span></a><span> </span><a href="#local-6989586621679325926"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><a name="possibleSrcFn"><a href="Striot.CompileIoT.html#possibleSrcFn"><span class="hs-identifier">possibleSrcFn</span></a></a><span> </span><a name="local-6989586621679325930"><a href="#local-6989586621679325930"><span class="hs-identifier">parts</span></a></a><span> </span><a name="local-6989586621679325931"><a href="#local-6989586621679325931"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-keyword">if</span><span>   </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679325930"><span class="hs-identifier hs-var">parts</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="Striot.CompileIoT.html#generateSrcFn"><span class="hs-identifier hs-var">generateSrcFn</span></a><span> </span><a href="#local-6989586621679325931"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-215"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#nodeType"><span class="hs-identifier hs-var">nodeType</span></a><span> </span><a href="#local-6989586621679325931"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-216"></a><span>             </span><a href="Striot.CompileIoT.html#NodeSource"><span class="hs-identifier hs-var">NodeSource</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#generateSrcFn"><span class="hs-identifier hs-var">generateSrcFn</span></a><span> </span><a href="#local-6989586621679325931"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-217"></a><span>             </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><a name="possibleSinkFn"><a href="Striot.CompileIoT.html#possibleSinkFn"><span class="hs-identifier">possibleSinkFn</span></a></a><span> </span><a name="local-6989586621679325932"><a href="#local-6989586621679325932"><span class="hs-identifier">parts</span></a></a><span> </span><a name="local-6989586621679325933"><a href="#local-6989586621679325933"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-keyword">if</span><span>   </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679325932"><span class="hs-identifier hs-var">parts</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-221"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="Striot.CompileIoT.html#generateSinkFn"><span class="hs-identifier hs-var">generateSinkFn</span></a><span> </span><a href="#local-6989586621679325933"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-222"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#nodeType"><span class="hs-identifier hs-var">nodeType</span></a><span> </span><a href="#local-6989586621679325933"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-223"></a><span>             </span><a href="Striot.CompileIoT.html#NodeSink"><span class="hs-identifier hs-var">NodeSink</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#generateSinkFn"><span class="hs-identifier hs-var">generateSinkFn</span></a><span> </span><a href="#local-6989586621679325933"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-224"></a><span>             </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><a name="possibleSrcSinkFn"><a href="Striot.CompileIoT.html#possibleSrcSinkFn"><span class="hs-identifier">possibleSrcSinkFn</span></a></a><span> </span><a name="local-6989586621679325934"><a href="#local-6989586621679325934"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#nodeType"><span class="hs-identifier hs-var">nodeType</span></a><span> </span><a href="#local-6989586621679325934"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-227"></a><span>    </span><a href="Striot.CompileIoT.html#NodeSource"><span class="hs-identifier hs-var">NodeSource</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#generateSrcFn"><span class="hs-identifier hs-var">generateSrcFn</span></a><span> </span><a href="#local-6989586621679325934"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-228"></a><span>    </span><a href="Striot.CompileIoT.html#NodeLink"><span class="hs-identifier hs-var">NodeLink</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-229"></a><span>    </span><a href="Striot.CompileIoT.html#NodeSink"><span class="hs-identifier hs-var">NodeSink</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#generateSinkFn"><span class="hs-identifier hs-var">generateSinkFn</span></a><span> </span><a href="#local-6989586621679325934"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-comment">-- output type of a StreamGraph.</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- special-case if the terminal node is a Sink node: we want the</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- &quot;pure&quot; StreamGraph type that feeds into the sink function.</span><span>
</span><a name="line-234"></a><span class="hs-identifier">outType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-235"></a><a name="outType"><a href="Striot.CompileIoT.html#outType"><span class="hs-identifier">outType</span></a></a><span> </span><a name="local-6989586621679325935"><a href="#local-6989586621679325935"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679325936"><a href="#local-6989586621679325936"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325935"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-236"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">operator</span><span> </span><a href="#local-6989586621679325936"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span>
</span><a name="line-237"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">intype</span><span> </span><a href="#local-6989586621679325936"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-238"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">outtype</span><span> </span><a href="#local-6989586621679325936"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-comment">-- input type of a StreamGraph</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- see outType for rationale</span><span>
</span><a name="line-242"></a><span class="hs-identifier">inType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-243"></a><a name="inType"><a href="Striot.CompileIoT.html#inType"><span class="hs-identifier">inType</span></a></a><span> </span><a name="local-6989586621679325937"><a href="#local-6989586621679325937"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679325938"><a href="#local-6989586621679325938"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325937"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-244"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Striot.StreamGraph.html#isSource"><span class="hs-identifier hs-var">isSource</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">operator</span><span> </span><a href="#local-6989586621679325938"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-245"></a><span>               </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">outtype</span><span> </span><a href="#local-6989586621679325938"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-246"></a><span>               </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">intype</span><span> </span><a href="#local-6989586621679325938"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><a name="t"><a href="Striot.CompileIoT.html#t"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span>       </span><span class="hs-string">&quot;IO Int&quot;</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-249"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="Striot.StreamGraph.html#Map"><span class="hs-identifier hs-var">Map</span></a><span>    </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span>       </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-250"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span>   </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;IO ()&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-251"></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><a name="test_outType"><a href="Striot.CompileIoT.html#test_outType"><span class="hs-identifier">test_outType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-254"></a><span>    </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#outType"><span class="hs-identifier hs-var">outType</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#createPartitions"><span class="hs-identifier hs-var">createPartitions</span></a><span> </span><a href="Striot.CompileIoT.html#t"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><a name="test_outType_sink"><a href="Striot.CompileIoT.html#test_outType_sink"><span class="hs-identifier">test_outType_sink</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#outType"><span class="hs-identifier hs-var">outType</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#createPartitions"><span class="hs-identifier hs-var">createPartitions</span></a><span> </span><a href="Striot.CompileIoT.html#t"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><a name="test_inType"><a href="Striot.CompileIoT.html#test_inType"><span class="hs-identifier">test_inType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-260"></a><span>    </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#inType"><span class="hs-identifier hs-var">inType</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#createPartitions"><span class="hs-identifier hs-var">createPartitions</span></a><span> </span><a href="Striot.CompileIoT.html#t"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-comment">-- determine the node(s?) to connect on to from this partition</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- XXX always 0 or 1? write quickcheck property...</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- TODO: this breaks if the outer-edge node has been optimised away...</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- the graph of cut edges has the pre-optimisation StreamVertex in it.</span><span>
</span><a name="line-266"></a><span class="hs-identifier">connectNodeId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">]</span><span>
</span><a name="line-267"></a><a name="connectNodeId"><a href="Striot.CompileIoT.html#connectNodeId"><span class="hs-identifier">connectNodeId</span></a></a><span> </span><a name="local-6989586621679325939"><a href="#local-6989586621679325939"><span class="hs-identifier">sg</span></a></a><span> </span><a name="local-6989586621679325940"><a href="#local-6989586621679325940"><span class="hs-identifier">parts</span></a></a><span> </span><a name="local-6989586621679325941"><a href="#local-6989586621679325941"><span class="hs-identifier">cuts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-268"></a><span>    </span><a name="local-6989586621679325942"><a href="#local-6989586621679325942"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">edgeList</span><span> </span><a href="#local-6989586621679325941"><span class="hs-identifier hs-var">cuts</span></a><span>
</span><a name="line-269"></a><span>    </span><a name="local-6989586621679325943"><a href="#local-6989586621679325943"><span class="hs-identifier">outs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679325939"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-270"></a><span>    </span><a name="local-6989586621679325944"><a href="#local-6989586621679325944"><span class="hs-identifier">outEs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679325947"><a href="#local-6989586621679325947"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325948"><a href="#local-6989586621679325948"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325947"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679325943"><span class="hs-identifier hs-var">outs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325942"><span class="hs-identifier hs-var">edges</span></a><span>
</span><a name="line-271"></a><span>    </span><a name="local-6989586621679325945"><a href="#local-6989586621679325945"><span class="hs-identifier">destVs</span></a></a><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679325944"><span class="hs-identifier hs-var">outEs</span></a><span>
</span><a name="line-272"></a><span>    </span><a name="local-6989586621679325946"><a href="#local-6989586621679325946"><span class="hs-identifier">destGs</span></a></a><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679325949"><a href="#local-6989586621679325949"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679325950"><a href="#local-6989586621679325950"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325951"><a href="#local-6989586621679325951"><span class="hs-identifier">sg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325949"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679325951"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325940"><span class="hs-identifier hs-var">parts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325945"><span class="hs-identifier hs-var">destVs</span></a><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679325946"><span class="hs-identifier hs-var">destGs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-275"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;connectNodeId returned an empty list, last vertex optimised away?&quot;</span><span>
</span><a name="line-276"></a><span>        </span><a name="local-6989586621679325952"><a href="#local-6989586621679325952"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325952"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-identifier">generateSrcFn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-279"></a><a name="generateSrcFn"><a href="Striot.CompileIoT.html#generateSrcFn"><span class="hs-identifier">generateSrcFn</span></a></a><span> </span><a name="local-6989586621679325953"><a href="#local-6989586621679325953"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;src1 = &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-280"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Striot.StreamGraph.html#showParam"><span class="hs-identifier hs-var">showParam</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">parameters</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679325953"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-identifier">generateSinkFn</span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-283"></a><a name="generateSinkFn"><a href="Striot.CompileIoT.html#generateSinkFn"><span class="hs-identifier">generateSinkFn</span></a></a><span> </span><a name="local-6989586621679325954"><a href="#local-6989586621679325954"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;sink1 :: Show a =&gt; Stream a -&gt; IO ()\nsink1 = &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Striot.StreamGraph.html#showParam"><span class="hs-identifier hs-var">showParam</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">parameters</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679325954"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-285"></a><span>
</span><a name="line-286"></a><span class="hs-identifier">generateNodeLink</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-287"></a><a name="generateNodeLink"><a href="Striot.CompileIoT.html#generateNodeLink"><span class="hs-identifier">generateNodeLink</span></a></a><span> </span><a name="local-6989586621679325955"><a href="#local-6989586621679325955"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;main = nodeLink (defaultLink \&quot;9001\&quot; \&quot;node&quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679325955"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;\&quot; \&quot;9001\&quot;) streamGraphFn&quot;</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-comment">-- warts:</span><span>
</span><a name="line-290"></a><span class="hs-comment">--  we accept a list of onward nodes but nodeSource only accepts one anyway</span><span>
</span><a name="line-291"></a><span class="hs-identifier">generateNodeSrc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier hs-type">GenerateOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-292"></a><a name="generateNodeSrc"><a href="Striot.CompileIoT.html#generateNodeSrc"><span class="hs-identifier">generateNodeSrc</span></a></a><span> </span><a name="local-6989586621679325956"><a href="#local-6989586621679325956"><span class="hs-identifier">partId</span></a></a><span> </span><a name="local-6989586621679325957"><a href="#local-6989586621679325957"><span class="hs-identifier">nodes</span></a></a><span> </span><a name="local-6989586621679325958"><a href="#local-6989586621679325958"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679325959"><a href="#local-6989586621679325959"><span class="hs-identifier">parts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-293"></a><span>    </span><a name="local-6989586621679325960"><a href="#local-6989586621679325960"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679325957"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-294"></a><span>    </span><a name="local-6989586621679325961"><a href="#local-6989586621679325961"><span class="hs-identifier">host</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;node&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679325960"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>    </span><a name="local-6989586621679325962"><a href="#local-6989586621679325962"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679325960"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621679325959"><span class="hs-identifier hs-var">parts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-297"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679325964"><a href="#local-6989586621679325964"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Striot.CompileIoT.html#startsWithJoin"><span class="hs-identifier hs-var">startsWithJoin</span></a><span> </span><a href="#local-6989586621679325964"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-298"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><span class="hs-number">9001</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679325956"><span class="hs-identifier hs-var">partId</span></a><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-comment">-- XXX Unlikely to always be correct</span><span>
</span><a name="line-299"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-number">9001</span><span>
</span><a name="line-300"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">9001</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>    </span><a name="local-6989586621679325963"><a href="#local-6989586621679325963"><span class="hs-identifier">pref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">preSource</span><span> </span><a href="#local-6989586621679325958"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-303"></a><span>       </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-304"></a><span>       </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679325965"><a href="#local-6989586621679325965"><span class="hs-identifier">f</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325965"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\n  &quot;</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-string">&quot;main = do\n  &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679325963"><span class="hs-identifier hs-var">pref</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#showParam"><span class="hs-identifier hs-var">showParam</span></a><span> </span><span class="hs-special">[|</span><span>
</span><a name="line-307"></a><span>        </span><span class="hs-identifier">nodeSource</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">defaultSource</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">litE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StringL</span><span> </span><a href="#local-6989586621679325961"><span class="hs-identifier hs-var">host</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>                                  </span><span class="hs-special">$(</span><span class="hs-identifier hs-var">litE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StringL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679325962"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>                   </span><span class="hs-identifier">src1</span><span> </span><span class="hs-identifier">streamGraphFn</span><span>
</span><a name="line-310"></a><span>    </span><span class="hs-special">|]</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- | does this StreamGraph start with a Join operator?</span><span>
</span><a name="line-313"></a><span class="hs-identifier">startsWithJoin</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-314"></a><a name="startsWithJoin"><a href="Striot.CompileIoT.html#startsWithJoin"><span class="hs-identifier">startsWithJoin</span></a></a><span> </span><a name="local-6989586621679325968"><a href="#local-6989586621679325968"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-315"></a><span>    </span><a name="local-6989586621679325969"><a href="#local-6989586621679325969"><span class="hs-identifier">joinOps</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><a href="Striot.StreamGraph.html#Join"><span class="hs-identifier hs-var">Join</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">.</span><span class="hs-identifier">operator</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679325968"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-316"></a><span>    </span><a name="local-6989586621679325970"><a href="#local-6989586621679325970"><span class="hs-identifier">hasInputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">edgeList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679325968"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-317"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679325969"><span class="hs-identifier hs-var">joinOps</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">or</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679325970"><span class="hs-identifier hs-var">hasInputs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679325969"><span class="hs-identifier hs-var">joinOps</span></a><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><a name="test_startsWithJoin_1"><a href="Striot.CompileIoT.html#test_startsWithJoin_1"><span class="hs-identifier">test_startsWithJoin_1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertBool</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">startsWithJoin</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-320"></a><span>    </span><span class="hs-special">[</span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="Striot.StreamGraph.html#Join"><span class="hs-identifier hs-var">Join</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="Striot.StreamGraph.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">2</span><span class="hs-special">]</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><a name="test_startsWithJoin_2"><a href="Striot.CompileIoT.html#test_startsWithJoin_2"><span class="hs-identifier">test_startsWithJoin_2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertBool</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">startsWithJoin</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-323"></a><span>    </span><span class="hs-special">[</span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="Striot.StreamGraph.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">3</span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="Striot.StreamGraph.html#Join"><span class="hs-identifier hs-var">Join</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">4</span><span class="hs-special">]</span><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><a name="test_startsWithJoin_3"><a href="Striot.CompileIoT.html#test_startsWithJoin_3"><span class="hs-identifier">test_startsWithJoin_3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertBool</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">startsWithJoin</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">empty</span><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span class="hs-identifier">generateNodeSink</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-328"></a><a name="generateNodeSink"><a href="Striot.CompileIoT.html#generateNodeSink"><span class="hs-identifier">generateNodeSink</span></a></a><span> </span><a name="local-6989586621679325971"><a href="#local-6989586621679325971"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;main = &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#showParam"><span class="hs-identifier hs-var">showParam</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="Striot.CompileIoT.html#startsWithJoin"><span class="hs-identifier hs-var">startsWithJoin</span></a><span> </span><a href="#local-6989586621679325971"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-330"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[|</span><span> </span><span class="hs-identifier">nodeSink2</span><span> </span><span class="hs-identifier">streamGraphFn</span><span> </span><span class="hs-identifier">sink1</span><span> </span><span class="hs-string">&quot;9001&quot;</span><span> </span><span class="hs-string">&quot;9002&quot;</span><span> </span><span class="hs-special">|]</span><span>
</span><a name="line-331"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[|</span><span> </span><span class="hs-identifier">nodeSink</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">defaultSink</span><span> </span><span class="hs-string">&quot;9001&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">streamGraphFn</span><span> </span><span class="hs-identifier">sink1</span><span> </span><span class="hs-special">|]</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-comment">-- generateCodeFromVertex:  generates Haskell code to be included in a</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- let expression, corresponding to the supplied StreamVertex. The Int</span><span>
</span><a name="line-335"></a><span class="hs-comment">-- argument represents the sequence order of the StreamVertex relative</span><span>
</span><a name="line-336"></a><span class="hs-comment">-- to others, and is used to calculate the names of the input stream</span><span>
</span><a name="line-337"></a><span class="hs-comment">-- argument(s).</span><span>
</span><a name="line-338"></a><span class="hs-comment">-- As the StreamVertex parameters may need to reference the input streams,</span><span>
</span><a name="line-339"></a><span class="hs-comment">-- the generated expression is wrapped in a lambda expression that names</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- them 's' for unary input streams and 's1, s2' for binary input streams</span><span>
</span><a name="line-341"></a><span class="hs-comment">-- (Join and, for the time being, Merge)</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- XXX: streamMerge is broken. We have no way of knowing how many input</span><span>
</span><a name="line-343"></a><span class="hs-comment">-- streams there are supposed to be, so we guess at 2.</span><span>
</span><a name="line-344"></a><span class="hs-identifier">generateCodeFromVertex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-type">StreamVertex</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-345"></a><a name="generateCodeFromVertex"><a href="Striot.CompileIoT.html#generateCodeFromVertex"><span class="hs-identifier">generateCodeFromVertex</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679325972"><a href="#local-6989586621679325972"><span class="hs-identifier">opid</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679325973"><a href="#local-6989586621679325973"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-346"></a><span>    </span><a name="local-6989586621679325974"><a href="#local-6989586621679325974"><span class="hs-identifier">op</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">operator</span><span> </span><a href="#local-6989586621679325973"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-347"></a><span>    </span><a name="local-6989586621679325975"><a href="#local-6989586621679325975"><span class="hs-identifier">lparams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679325974"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="Striot.StreamGraph.html#Join"><span class="hs-identifier hs-var">Join</span></a><span class="hs-special">,</span><a href="Striot.StreamGraph.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;s1 s2&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;s&quot;</span><span>
</span><a name="line-348"></a><span>    </span><a name="local-6989586621679325976"><a href="#local-6989586621679325976"><span class="hs-identifier">params</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#paren"><span class="hs-identifier hs-var">paren</span></a><span class="hs-operator hs-var">.</span><a href="Striot.StreamGraph.html#showParam"><span class="hs-identifier hs-var">showParam</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">parameters</span><span> </span><a href="#local-6989586621679325973"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>    </span><a name="local-6989586621679325977"><a href="#local-6989586621679325977"><span class="hs-identifier">args</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679325974"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="Striot.StreamGraph.html#Join"><span class="hs-identifier hs-var">Join</span></a><span class="hs-special">,</span><a href="Striot.StreamGraph.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span class="hs-special">]</span><span>
</span><a name="line-350"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;n&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325972"><span class="hs-identifier hs-var">opid</span></a><span class="hs-glyph">-</span><span class="hs-number">2</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; n&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325972"><span class="hs-identifier hs-var">opid</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-351"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;n&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325972"><span class="hs-identifier hs-var">opid</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-352"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-353"></a><span>        </span><span class="hs-comment">--&quot;n&quot; ++ show opid ++ &quot; = (\\&quot; ++ lparams ++ &quot; -&gt; &quot; ++ printOp op ++ &quot; &quot; ++ params ++ &quot; &quot;++lparams++&quot;) &quot; ++ args</span><span>
</span><a name="line-354"></a><span>        </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;n&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679325972"><span class="hs-identifier hs-var">opid</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; = (\\&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679325975"><span class="hs-identifier hs-var">lparams</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; -&gt; &quot;</span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#printOp"><span class="hs-identifier hs-var">printOp</span></a><span> </span><a href="#local-6989586621679325974"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; &quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679325976"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; &quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679325975"><span class="hs-identifier hs-var">lparams</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;) &quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679325977"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">]</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">paren</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-357"></a><a name="paren"><a href="Striot.CompileIoT.html#paren"><span class="hs-identifier">paren</span></a></a><span> </span><a name="local-6989586621679325978"><a href="#local-6989586621679325978"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;(&quot;</span><span class="hs-operator hs-var">++</span><a href="#local-6989586621679325978"><span class="hs-identifier hs-var">s</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span class="hs-identifier">printOp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamOperator"><span class="hs-identifier hs-type">StreamOperator</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-360"></a><a name="printOp"><a href="Striot.CompileIoT.html#printOp"><span class="hs-identifier">printOp</span></a></a><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Filter"><span class="hs-identifier hs-var">Filter</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;streamFilter&quot;</span><span>
</span><a name="line-361"></a><span class="hs-identifier">printOp</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#FilterAcc"><span class="hs-identifier hs-var">FilterAcc</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;streamFilterAcc&quot;</span><span>
</span><a name="line-362"></a><span class="hs-identifier">printOp</span><span> </span><a name="local-6989586621679325979"><a href="#local-6989586621679325979"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;stream&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679325979"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span class="hs-comment">-- how many incoming edges to this partition?</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- + how many source nodes</span><span>
</span><a name="line-366"></a><span class="hs-identifier">partValence</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-367"></a><a name="partValence"><a href="Striot.CompileIoT.html#partValence"><span class="hs-identifier">partValence</span></a></a><span> </span><a name="local-6989586621679325980"><a href="#local-6989586621679325980"><span class="hs-identifier">g</span></a></a><span> </span><a name="local-6989586621679325981"><a href="#local-6989586621679325981"><span class="hs-identifier">cuts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-368"></a><span>    </span><a name="local-6989586621679325982"><a href="#local-6989586621679325982"><span class="hs-identifier">verts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679325980"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-369"></a><span>    </span><a name="local-6989586621679325983"><a href="#local-6989586621679325983"><span class="hs-identifier">inEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679325985"><a href="#local-6989586621679325985"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679325985"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679325982"><span class="hs-identifier hs-var">verts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">edgeList</span><span> </span><a href="#local-6989586621679325981"><span class="hs-identifier hs-var">cuts</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>    </span><a name="local-6989586621679325984"><a href="#local-6989586621679325984"><span class="hs-identifier">sourceNodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#isSource"><span class="hs-identifier hs-var">isSource</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">operator</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679325980"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-372"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679325984"><span class="hs-identifier hs-var">sourceNodes</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679325983"><span class="hs-identifier hs-var">inEdges</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-375"></a><span class="hs-comment">-- tests / test data</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><a name="main"><a href="Striot.CompileIoT.html#main"><span class="hs-identifier">main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">htfMain</span><span> </span><a href="Striot.CompileIoT.html#htf_Striot_CompileIoT_thisModulesTests"><span class="hs-identifier hs-var">htf_thisModulesTests</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-comment">-- Source -&gt; Sink</span><span>
</span><a name="line-380"></a><a name="s0"><a href="Striot.CompileIoT.html#s0"><span class="hs-identifier">s0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">connect</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Vertex</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Vertex</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">-- Source -&gt; Filter -&gt; Sink</span><span>
</span><a name="line-384"></a><a name="s1"><a href="Striot.CompileIoT.html#s1"><span class="hs-identifier">s1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-385"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Filter"><span class="hs-identifier hs-var">Filter</span></a><span> </span><span class="hs-number">0.5</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-386"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-387"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><a name="test_reform_s0"><a href="Striot.CompileIoT.html#test_reform_s0"><span class="hs-identifier">test_reform_s0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-identifier">s0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unPartition</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">createPartitions</span><span> </span><span class="hs-identifier">s0</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><a name="test_reform_s1"><a href="Striot.CompileIoT.html#test_reform_s1"><span class="hs-identifier">test_reform_s1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-identifier">s1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unPartition</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">createPartitions</span><span> </span><span class="hs-identifier">s1</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-391"></a><a name="test_reform_s1_2"><a href="Striot.CompileIoT.html#test_reform_s1_2"><span class="hs-identifier">test_reform_s1_2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-identifier">s1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unPartition</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">createPartitions</span><span> </span><span class="hs-identifier">s1</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><a name="genDockerfile"><a href="Striot.CompileIoT.html#genDockerfile"><span class="hs-identifier">genDockerfile</span></a></a><span> </span><a name="local-6989586621679325986"><a href="#local-6989586621679325986"><span class="hs-identifier">listen</span></a></a><span> </span><a name="local-6989586621679325987"><a href="#local-6989586621679325987"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-394"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679325988"><a href="#local-6989586621679325988"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">packages</span><span> </span><a href="#local-6989586621679325987"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-395"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;FROM striot/striot-base:latest\n&quot;</span><span>
</span><a name="line-396"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;WORKDIR /opt/node\n&quot;</span><span>
</span><a name="line-397"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;COPY . /opt/node\n&quot;</span><span>
</span><a name="line-398"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679325988"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;RUN cabal install &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><a href="#local-6989586621679325988"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-399"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-400"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;RUN ghc node.hs\n&quot;</span><span>
</span><a name="line-401"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679325986"><span class="hs-identifier hs-var">listen</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;EXPOSE 9001\n&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-402"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;CMD /opt/node/node\n&quot;</span><span>
</span><a name="line-403"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span class="hs-comment">-- XXX rename</span><span>
</span><a name="line-406"></a><span class="hs-identifier">writePart</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier hs-type">GenerateOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-407"></a><a name="writePart"><a href="Striot.CompileIoT.html#writePart"><span class="hs-identifier">writePart</span></a></a><span> </span><a name="local-6989586621679325989"><a href="#local-6989586621679325989"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679325990"><a href="#local-6989586621679325990"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-6989586621679325991"><a href="#local-6989586621679325991"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-408"></a><span>    </span><a name="local-6989586621679325992"><a href="#local-6989586621679325992"><span class="hs-identifier">dockerfile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#genDockerfile"><span class="hs-identifier hs-var">genDockerfile</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621679325989"><span class="hs-identifier hs-var">opts</span></a><span>
</span><a name="line-409"></a><span>    </span><a name="local-6989586621679325993"><a href="#local-6989586621679325993"><span class="hs-identifier">bn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;node&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679325990"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span>    </span><a name="local-6989586621679325994"><a href="#local-6989586621679325994"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679325993"><span class="hs-identifier hs-var">bn</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;node.hs&quot;</span><span>
</span><a name="line-411"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-412"></a><span>        </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621679325993"><span class="hs-identifier hs-var">bn</span></a><span>
</span><a name="line-413"></a><span>        </span><span class="hs-identifier hs-var">writeFile</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679325993"><span class="hs-identifier hs-var">bn</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;Dockerfile&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679325992"><span class="hs-identifier hs-var">dockerfile</span></a><span>
</span><a name="line-414"></a><span>        </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621679325994"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621679325991"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-comment">-- |Partitions the supplied `StreamGraph` according to the supplied `PartitionMap`;</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- invokes `generateCode` for each derived sub-graph; writes out the resulting</span><span>
</span><a name="line-418"></a><span class="hs-comment">-- source code to individual source code files, one per node.</span><span>
</span><a name="line-419"></a><span class="hs-identifier">partitionGraph</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#PartitionMap"><span class="hs-identifier hs-type">PartitionMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#GenerateOpts"><span class="hs-identifier hs-type">GenerateOpts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-420"></a><a name="partitionGraph"><a href="Striot.CompileIoT.html#partitionGraph"><span class="hs-identifier">partitionGraph</span></a></a><span> </span><a name="local-6989586621679326123"><a href="#local-6989586621679326123"><span class="hs-identifier">graph</span></a></a><span> </span><a name="local-6989586621679326124"><a href="#local-6989586621679326124"><span class="hs-identifier">partitions</span></a></a><span> </span><a name="local-6989586621679326125"><a href="#local-6989586621679326125"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-421"></a><span>    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#writePart"><span class="hs-identifier hs-var">writePart</span></a><span> </span><a href="#local-6989586621679326125"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.CompileIoT.html#generateCode"><span class="hs-identifier hs-var">generateCode</span></a><span> </span><a href="#local-6989586621679326123"><span class="hs-identifier hs-var">graph</span></a><span> </span><a href="#local-6989586621679326124"><span class="hs-identifier hs-var">partitions</span></a><span> </span><a href="#local-6989586621679326125"><span class="hs-identifier hs-var">opts</span></a><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-comment">-- |Convenience function for specifying a simple path-style of stream processing</span><span>
</span><a name="line-424"></a><span class="hs-comment">-- program, with no merge or join operations. The list of tuples are converted</span><span>
</span><a name="line-425"></a><span class="hs-comment">-- into a series of connected Stream Vertices in a Graph. The tuple arguments are</span><span>
</span><a name="line-426"></a><span class="hs-comment">-- the relevant `StreamOperator` for the node; the parameters and the *output*</span><span>
</span><a name="line-427"></a><span class="hs-comment">-- type. The other parameters to `StreamVertex` are inferred from the neighbouring</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- tuples. Unique and ascending `vertexId` values are assigned.</span><span>
</span><a name="line-429"></a><span class="hs-identifier">simpleStream</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#StreamOperator"><span class="hs-identifier hs-type">StreamOperator</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExpQ</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-type">StreamVertex</span></a><span>
</span><a name="line-430"></a><a name="simpleStream"><a href="Striot.CompileIoT.html#simpleStream"><span class="hs-identifier">simpleStream</span></a></a><span> </span><a name="local-6989586621679326126"><a href="#local-6989586621679326126"><span class="hs-identifier">tupes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">path</span><span> </span><a href="#local-6989586621679326129"><span class="hs-identifier hs-var">lst</span></a><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-433"></a><span>        </span><a name="local-6989586621679326127"><a href="#local-6989586621679326127"><span class="hs-identifier">intypes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;IO ()&quot;</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679326130"><a href="#local-6989586621679326130"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679326130"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">init</span><span> </span><a href="#local-6989586621679326126"><span class="hs-identifier hs-var">tupes</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>        </span><a name="local-6989586621679326128"><a href="#local-6989586621679326128"><span class="hs-identifier">tupes3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip3</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679326127"><span class="hs-identifier hs-var">intypes</span></a><span> </span><a href="#local-6989586621679326126"><span class="hs-identifier hs-var">tupes</span></a><span>
</span><a name="line-435"></a><span>        </span><a name="local-6989586621679326129"><a href="#local-6989586621679326129"><span class="hs-identifier">lst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679326131"><a href="#local-6989586621679326131"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><a name="local-6989586621679326132"><a href="#local-6989586621679326132"><span class="hs-identifier">intype</span></a></a><span class="hs-special">,</span><span class="hs-special">(</span><a name="local-6989586621679326133"><a href="#local-6989586621679326133"><span class="hs-identifier">op</span></a></a><span class="hs-special">,</span><a name="local-6989586621679326134"><a href="#local-6989586621679326134"><span class="hs-identifier">params</span></a></a><span class="hs-special">,</span><a name="local-6989586621679326135"><a href="#local-6989586621679326135"><span class="hs-identifier">outtype</span></a></a><span class="hs-special">,</span><a name="local-6989586621679326136"><a href="#local-6989586621679326136"><span class="hs-identifier">sTime</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-436"></a><span>            </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><a href="#local-6989586621679326131"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679326133"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621679326134"><span class="hs-identifier hs-var">params</span></a><span> </span><a href="#local-6989586621679326132"><span class="hs-identifier hs-var">intype</span></a><span> </span><a href="#local-6989586621679326135"><span class="hs-identifier hs-var">outtype</span></a><span> </span><a href="#local-6989586621679326136"><span class="hs-identifier hs-var">sTime</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679326128"><span class="hs-identifier hs-var">tupes3</span></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span class="hs-comment">-- | Derive a partition map.</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- Eventually, derive all possible partition maps.</span><span>
</span><a name="line-442"></a><span class="hs-identifier">partitionings</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#Partition"><span class="hs-identifier hs-type">Partition</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#PartitionMap"><span class="hs-identifier hs-type">PartitionMap</span></a><span>
</span><a name="line-443"></a><a name="partitionings"><a href="Striot.CompileIoT.html#partitionings"><span class="hs-identifier">partitionings</span></a></a><span> </span><a name="local-6989586621679326137"><a href="#local-6989586621679326137"><span class="hs-identifier">sg</span></a></a><span> </span><a name="local-6989586621679326138"><a href="#local-6989586621679326138"><span class="hs-identifier">parts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-444"></a><span>    </span><a name="local-6989586621679326139"><a href="#local-6989586621679326139"><span class="hs-identifier">vIds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">vertexId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">vertexList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679326137"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-445"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">compareLength</span><span> </span><a href="#local-6989586621679326139"><span class="hs-identifier hs-var">vIds</span></a><span> </span><a href="#local-6989586621679326138"><span class="hs-identifier hs-var">parts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-446"></a><span>        </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679326139"><span class="hs-identifier hs-var">vIds</span></a><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span>        </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-449"></a><span>            </span><a name="local-6989586621679326200"><a href="#local-6989586621679326200"><span class="hs-identifier">diff</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679326139"><span class="hs-identifier hs-var">vIds</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679326138"><span class="hs-identifier hs-var">parts</span></a><span>
</span><a name="line-450"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621679326201"><a href="#local-6989586621679326201"><span class="hs-identifier">first</span></a></a><span class="hs-special">,</span><a name="local-6989586621679326202"><a href="#local-6989586621679326202"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679326200"><span class="hs-identifier hs-var">diff</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679326139"><span class="hs-identifier hs-var">vIds</span></a><span>
</span><a name="line-451"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679326201"><span class="hs-identifier hs-var">first</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679326202"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span>        </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;cannot partition a graph over more partitions than there are nodes&quot;</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><a name="partTestGraph"><a href="Striot.CompileIoT.html#partTestGraph"><span class="hs-identifier">partTestGraph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">path</span><span>
</span><a name="line-456"></a><span>    </span><span class="hs-special">[</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>        </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-457"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="Striot.StreamGraph.html#Map"><span class="hs-identifier hs-var">Map</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-458"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Filter"><span class="hs-identifier hs-var">Filter</span></a><span> </span><span class="hs-number">0.5</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">[|</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;</span><span class="hs-number">3</span><span class="hs-special">)</span><span> </span><span class="hs-special">|]</span><span class="hs-special">]</span><span>    </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-string">&quot;Int&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-459"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">3</span><span> </span><a href="Striot.StreamGraph.html#Window"><span class="hs-identifier hs-var">Window</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>        </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;[String]&quot;</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-460"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">4</span><span> </span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>          </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-string">&quot;String&quot;</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-461"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><a name="test_partitionings_1"><a href="Striot.CompileIoT.html#test_partitionings_1"><span class="hs-identifier">test_partitionings_1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-var">x</span><span class="hs-special">]</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">x</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-464"></a><span>    </span><a href="Striot.CompileIoT.html#partitionings"><span class="hs-identifier hs-var">partitionings</span></a><span> </span><a href="Striot.CompileIoT.html#partTestGraph"><span class="hs-identifier hs-var">partTestGraph</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-number">4</span><span class="hs-special">]</span><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><a name="test_partitionings_2"><a href="Striot.CompileIoT.html#test_partitionings_2"><span class="hs-identifier">test_partitionings_2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-467"></a><span>    </span><a href="Striot.CompileIoT.html#partitionings"><span class="hs-identifier hs-var">partitionings</span></a><span> </span><a href="Striot.CompileIoT.html#partTestGraph"><span class="hs-identifier hs-var">partTestGraph</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-number">2</span><span class="hs-special">]</span><span>
</span><a name="line-468"></a><span>
</span><a name="line-469"></a><a name="test_partitionings_3"><a href="Striot.CompileIoT.html#test_partitionings_3"><span class="hs-identifier">test_partitionings_3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">head</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-470"></a><span>    </span><a href="Striot.CompileIoT.html#partitionings"><span class="hs-identifier hs-var">partitionings</span></a><span> </span><a href="Striot.CompileIoT.html#partTestGraph"><span class="hs-identifier hs-var">partTestGraph</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-number">2</span><span class="hs-special">]</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span class="hs-comment">-- | placeholder</span><span>
</span><a name="line-473"></a><span class="hs-identifier">allPartitionings</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#Partition"><span class="hs-identifier hs-type">Partition</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#PartitionMap"><span class="hs-identifier hs-type">PartitionMap</span></a><span class="hs-special">]</span><span>
</span><a name="line-474"></a><a name="allPartitionings"><a href="Striot.CompileIoT.html#allPartitionings"><span class="hs-identifier">allPartitionings</span></a></a><span> </span><a name="local-6989586621679326204"><a href="#local-6989586621679326204"><span class="hs-identifier">sg</span></a></a><span> </span><a name="local-6989586621679326205"><a href="#local-6989586621679326205"><span class="hs-identifier">pt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-475"></a><span>    </span><a name="local-6989586621679326206"><a href="#local-6989586621679326206"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679326205"><span class="hs-identifier hs-var">pt</span></a><span>
</span><a name="line-476"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><a href="#local-6989586621679326206"><span class="hs-identifier hs-var">count</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">length</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#allPartitions"><span class="hs-identifier hs-var">allPartitions</span></a><span> </span><a href="#local-6989586621679326204"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-comment">-- | write out all rewritten versions of the input StreamGraph, along with some</span><span>
</span><a name="line-481"></a><span class="hs-comment">-- of the necessary supporting code.</span><span>
</span><a name="line-482"></a><span class="hs-comment">-- TODO: rename this to something more intuitive</span><span>
</span><a name="line-483"></a><span class="hs-identifier">optimiseWriteOutAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#Partition"><span class="hs-identifier hs-type">Partition</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><a name="optimiseWriteOutAll"><a href="Striot.CompileIoT.html#optimiseWriteOutAll"><span class="hs-identifier">optimiseWriteOutAll</span></a></a><span> </span><a name="local-6989586621679326207"><a href="#local-6989586621679326207"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621679326208"><a href="#local-6989586621679326208"><span class="hs-identifier">parts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-485"></a><span>    </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621679326207"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-486"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><a href="Striot.CompileIoT.html#template"><span class="hs-identifier hs-var">template</span></a><span>
</span><a name="line-487"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;\n    , &quot;</span><span>
</span><a name="line-488"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">show</span><span>
</span><a name="line-489"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><a href="Striot.CompileIoT.html#deriveStreamGraphOptions"><span class="hs-identifier hs-var">deriveStreamGraphOptions</span></a><span> </span><a href="#local-6989586621679326208"><span class="hs-identifier hs-var">parts</span></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-comment">-- | Apply the Logical Optimiser to the supplied StreamGraph and then return a</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- list of all possible pairings of StreamGraphs and Partition Maps</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- TODO tests for this pure bit</span><span>
</span><a name="line-494"></a><span class="hs-identifier">deriveStreamGraphOptions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#Partition"><span class="hs-identifier hs-type">Partition</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#PartitionMap"><span class="hs-identifier hs-type">PartitionMap</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-495"></a><a name="deriveStreamGraphOptions"><a href="Striot.CompileIoT.html#deriveStreamGraphOptions"><span class="hs-identifier">deriveStreamGraphOptions</span></a></a><span> </span><a name="local-6989586621679326209"><a href="#local-6989586621679326209"><span class="hs-identifier">parts</span></a></a><span> </span><a name="local-6989586621679326210"><a href="#local-6989586621679326210"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-496"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679326211"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621679326212"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679326211"><a href="#local-6989586621679326211"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Striot.CompileIoT.html#optimise%27"><span class="hs-identifier hs-var">optimise'</span></a><span> </span><a href="#local-6989586621679326210"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679326212"><a href="#local-6989586621679326212"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Striot.CompileIoT.html#allPartitionings"><span class="hs-identifier hs-var">allPartitionings</span></a><span> </span><a href="#local-6989586621679326211"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679326209"><span class="hs-identifier hs-var">parts</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span class="hs-identifier">optimise'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span class="hs-special">]</span><span>
</span><a name="line-499"></a><a name="optimise%27"><a href="Striot.CompileIoT.html#optimise%27"><span class="hs-identifier">optimise'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">simplify</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Striot.LogicalOptimiser.html#applyRules"><span class="hs-identifier hs-var">applyRules</span></a><span> </span><span class="hs-number">5</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-comment">-- first ensure that the Logical Optimiser produces at least one rewritten graph</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- for this test input</span><span>
</span><a name="line-503"></a><a name="test_ensureOptimised%27"><a href="Striot.CompileIoT.html#test_ensureOptimised%27"><span class="hs-identifier">test_ensureOptimised'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertBool</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">optimise'</span><span> </span><span class="hs-identifier">partTestGraph</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&gt;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span class="hs-comment">-- we must have at least as many options after considering partition mapping as</span><span>
</span><a name="line-506"></a><span class="hs-comment">-- we have StreamGraphs</span><span>
</span><a name="line-507"></a><a name="test_deriveStreamGraphOptions"><a href="Striot.CompileIoT.html#test_deriveStreamGraphOptions"><span class="hs-identifier">test_deriveStreamGraphOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertBool</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-508"></a><span>    </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#optimise%27"><span class="hs-identifier hs-var">optimise'</span></a><span> </span><a href="Striot.CompileIoT.html#partTestGraph"><span class="hs-identifier hs-var">partTestGraph</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#deriveStreamGraphOptions"><span class="hs-identifier hs-var">deriveStreamGraphOptions</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-number">4</span><span class="hs-special">]</span><span> </span><a href="Striot.CompileIoT.html#partTestGraph"><span class="hs-identifier hs-var">partTestGraph</span></a><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><a name="template"><a href="Striot.CompileIoT.html#template"><span class="hs-identifier">template</span></a></a><span> </span><a name="local-6989586621679326213"><a href="#local-6989586621679326213"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-511"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;import Striot.StreamGraph&quot;</span><span>
</span><a name="line-512"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;import Algebra.Graph&quot;</span><span>
</span><a name="line-513"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-514"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;graphs = &quot;</span><span>
</span><a name="line-515"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;    [ &quot;</span><span class="hs-operator hs-var">++</span><a href="#local-6989586621679326213"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-516"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;    ]\n&quot;</span><span>
</span><a name="line-517"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span class="hs-identifier">allPartitions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-522"></a><a name="allPartitions"><a href="Striot.CompileIoT.html#allPartitions"><span class="hs-identifier">allPartitions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">vertexId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Striot.CompileIoT.html#foldgl"><span class="hs-identifier hs-var">foldgl</span></a><span> </span><a href="#local-6989586621679326214"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">transpose</span><span>
</span><a name="line-523"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-524"></a><span>        </span><a name="local-6989586621679326214"><a href="#local-6989586621679326214"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>      </span><a name="local-6989586621679326215"><a href="#local-6989586621679326215"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">[</span><a href="#local-6989586621679326215"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-525"></a><span>        </span><span class="hs-identifier">fun</span><span> </span><a name="local-6989586621679326216"><a href="#local-6989586621679326216"><span class="hs-identifier">choices</span></a></a><span> </span><a name="local-6989586621679326217"><a href="#local-6989586621679326217"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#extendPartitioning"><span class="hs-identifier hs-var">extendPartitioning</span></a><span> </span><a href="#local-6989586621679326217"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679326216"><span class="hs-identifier hs-var">choices</span></a><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-comment">-- | A left-fold over Graphs. Unlike 'foldg', the traversal order follows</span><span>
</span><a name="line-528"></a><span class="hs-comment">-- edges from a root node.</span><span>
</span><a name="line-529"></a><span class="hs-comment">--</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- XXX could we rework this in terms of subGraph, instead of subGraphs?</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- Caveat: when the incoming graph is e.g. overlay x y, getRoot returns</span><span>
</span><a name="line-532"></a><span class="hs-comment">-- one of x or y, and subGraphs returns [], so we lose the other branch</span><span>
</span><a name="line-533"></a><span class="hs-identifier">foldgl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679325871"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679325871"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-534"></a><span>               </span><span class="hs-special">(</span><a href="#local-6989586621679325872"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325871"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325872"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325872"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="#local-6989586621679325871"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325872"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-535"></a><a name="foldgl"><a href="Striot.CompileIoT.html#foldgl"><span class="hs-identifier">foldgl</span></a></a><span> </span><a name="local-6989586621679326218"><a href="#local-6989586621679326218"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679326219"><a href="#local-6989586621679326219"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621679326220"><a href="#local-6989586621679326220"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-536"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isEmpty</span><span> </span><a href="#local-6989586621679326220"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679326219"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-537"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679326221"><a href="#local-6989586621679326221"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#getRoot"><span class="hs-identifier hs-var">getRoot</span></a><span> </span><a href="#local-6989586621679326220"><span class="hs-identifier hs-var">g</span></a><span>     </span><span class="hs-comment">-- :: a</span><span>
</span><a name="line-538"></a><span>             </span><a name="local-6989586621679326222"><a href="#local-6989586621679326222"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#subGraphs"><span class="hs-identifier hs-var">subGraphs</span></a><span> </span><a href="#local-6989586621679326221"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679326220"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-comment">-- [Graph a]</span><span>
</span><a name="line-539"></a><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679326223"><a href="#local-6989586621679326223"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679326224"><a href="#local-6989586621679326224"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#foldgl"><span class="hs-identifier hs-var">foldgl</span></a><span> </span><a href="#local-6989586621679326218"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679326223"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679326224"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679326218"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679326219"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621679326221"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679326222"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><a name="test_foldgl1"><a href="Striot.CompileIoT.html#test_foldgl1"><span class="hs-identifier">test_foldgl1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-string">&quot;ABC&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-542"></a><span>    </span><a href="Striot.CompileIoT.html#foldgl"><span class="hs-identifier hs-var">foldgl</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679326225"><a href="#local-6989586621679326225"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679326226"><a href="#local-6989586621679326226"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679326225"><span class="hs-identifier hs-var">b</span></a><span class="hs-operator hs-var">++</span><span class="hs-special">[</span><a href="#local-6989586621679326226"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-string">&quot;ABC&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><a name="test_foldgl2"><a href="Striot.CompileIoT.html#test_foldgl2"><span class="hs-identifier">test_foldgl2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-string">&quot;ABCD&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-544"></a><span>    </span><a href="Striot.CompileIoT.html#foldgl"><span class="hs-identifier hs-var">foldgl</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679326227"><a href="#local-6989586621679326227"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679326228"><a href="#local-6989586621679326228"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679326227"><span class="hs-identifier hs-var">b</span></a><span class="hs-operator hs-var">++</span><span class="hs-special">[</span><a href="#local-6989586621679326228"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">overlay</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-string">&quot;ABC&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-string">&quot;BD&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-identifier">getRoots</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679325870"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679325870"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-547"></a><span>            </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="#local-6989586621679325870"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679325870"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-548"></a><a name="getRoots"><a href="Striot.CompileIoT.html#getRoots"><span class="hs-identifier">getRoots</span></a></a><span> </span><a name="local-6989586621679326229"><a href="#local-6989586621679326229"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-549"></a><span>    </span><a name="local-6989586621679326230"><a href="#local-6989586621679326230"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">edgeList</span><span> </span><a href="#local-6989586621679326229"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-550"></a><span>    </span><a name="local-6989586621679326231"><a href="#local-6989586621679326231"><span class="hs-identifier">dests</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621679326230"><span class="hs-identifier hs-var">edges</span></a><span>
</span><a name="line-551"></a><span>    </span><a name="local-6989586621679326232"><a href="#local-6989586621679326232"><span class="hs-identifier">roots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span class="hs-operator hs-var">.</span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><a href="#local-6989586621679326231"><span class="hs-identifier hs-var">dests</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vertexList</span><span> </span><a href="#local-6989586621679326229"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679326232"><span class="hs-identifier hs-var">roots</span></a><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span class="hs-identifier">getRoot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679325869"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679325869"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-555"></a><span>           </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="#local-6989586621679325869"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679325869"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-556"></a><a name="getRoot"><a href="Striot.CompileIoT.html#getRoot"><span class="hs-identifier">getRoot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Striot.CompileIoT.html#getRoots"><span class="hs-identifier hs-var">getRoots</span></a><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span class="hs-identifier">subGraphs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679325868"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-559"></a><span>             </span><a href="#local-6989586621679325868"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="#local-6989586621679325868"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="#local-6989586621679325868"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-560"></a><a name="subGraphs"><a href="Striot.CompileIoT.html#subGraphs"><span class="hs-identifier">subGraphs</span></a></a><span> </span><a name="local-6989586621679326233"><a href="#local-6989586621679326233"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679326234"><a href="#local-6989586621679326234"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679326235"><a href="#local-6989586621679326235"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Striot.CompileIoT.html#subGraph"><span class="hs-identifier hs-var">subGraph</span></a><span> </span><a href="#local-6989586621679326235"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679326234"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#childrenOf"><span class="hs-identifier hs-var">childrenOf</span></a><span> </span><a href="#local-6989586621679326233"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679326234"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><a name="test_subGraphs1"><a href="Striot.CompileIoT.html#test_subGraphs1"><span class="hs-identifier">test_subGraphs1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraphs</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-identifier">t2</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Vertex</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">3</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-563"></a><a name="test_subGraphs2"><a href="Striot.CompileIoT.html#test_subGraphs2"><span class="hs-identifier">test_subGraphs2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraphs</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-identifier">t2</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-564"></a><a name="test_subGraphs3"><a href="Striot.CompileIoT.html#test_subGraphs3"><span class="hs-identifier">test_subGraphs3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraphs</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">t1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">path</span><span> </span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-565"></a><a name="test_subGraphs4"><a href="Striot.CompileIoT.html#test_subGraphs4"><span class="hs-identifier">test_subGraphs4</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraphs</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">t2</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">removeVertex</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">t2</span><span class="hs-special">]</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><a name="v0"><a href="Striot.CompileIoT.html#v0"><span class="hs-identifier">v0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-568"></a><a name="v1"><a href="Striot.CompileIoT.html#v1"><span class="hs-identifier">v1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="Striot.StreamGraph.html#Map"><span class="hs-identifier hs-var">Map</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-569"></a><a name="v2"><a href="Striot.CompileIoT.html#v2"><span class="hs-identifier">v2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-570"></a><a name="v3"><a href="Striot.CompileIoT.html#v3"><span class="hs-identifier">v3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#Source"><span class="hs-identifier hs-var">Source</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-571"></a><a name="v4"><a href="Striot.CompileIoT.html#v4"><span class="hs-identifier">v4</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">4</span><span> </span><a href="Striot.StreamGraph.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-572"></a><a name="v5"><a href="Striot.CompileIoT.html#v5"><span class="hs-identifier">v5</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-var">StreamVertex</span></a><span> </span><span class="hs-number">5</span><span> </span><a href="Striot.StreamGraph.html#Map"><span class="hs-identifier hs-var">Map</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-573"></a><a name="g3"><a href="Striot.CompileIoT.html#g3"><span class="hs-identifier">g3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">overlay</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#v0"><span class="hs-identifier hs-var">v0</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v1"><span class="hs-identifier hs-var">v1</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v4"><span class="hs-identifier hs-var">v4</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v2"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#v3"><span class="hs-identifier hs-var">v3</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v5"><span class="hs-identifier hs-var">v5</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v4"><span class="hs-identifier hs-var">v4</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-574"></a><a name="g4"><a href="Striot.CompileIoT.html#g4"><span class="hs-identifier">g4</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">transpose</span><span> </span><a href="Striot.CompileIoT.html#g3"><span class="hs-identifier hs-var">g3</span></a><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><a name="test_subGraphs5"><a href="Striot.CompileIoT.html#test_subGraphs5"><span class="hs-identifier">test_subGraphs5</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-577"></a><span>    </span><a name="local-6989586621679326237"><a href="#local-6989586621679326237"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.CompileIoT.html#subGraphs"><span class="hs-identifier hs-var">subGraphs</span></a><span> </span><span class="hs-special">(</span><a href="Striot.CompileIoT.html#getRoot"><span class="hs-identifier hs-var">getRoot</span></a><span> </span><a href="Striot.CompileIoT.html#g4"><span class="hs-identifier hs-var">g4</span></a><span class="hs-special">)</span><span> </span><a href="Striot.CompileIoT.html#g4"><span class="hs-identifier hs-var">g4</span></a><span>
</span><a name="line-578"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier">assertBool</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">v0</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">vertexList</span><span> </span><span class="hs-identifier">g</span><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-identifier">subGraph</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679325867"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679325867"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-581"></a><span>            </span><a href="#local-6989586621679325867"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="#local-6989586621679325867"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="#local-6989586621679325867"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-582"></a><a name="subGraph"><a href="Striot.CompileIoT.html#subGraph"><span class="hs-identifier">subGraph</span></a></a><span> </span><a name="local-6989586621679326238"><a href="#local-6989586621679326238"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679326239"><a href="#local-6989586621679326239"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">induce</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">reachable</span><span> </span><a href="#local-6989586621679326238"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679326239"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679326239"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><a name="t1"><a href="Striot.CompileIoT.html#t1"><span class="hs-identifier">t1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span>
</span><a name="line-585"></a><a name="test_subGraph1"><a href="Striot.CompileIoT.html#test_subGraph1"><span class="hs-identifier">test_subGraph1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraph</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">t1</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">t1</span><span>
</span><a name="line-586"></a><a name="test_subGraph2"><a href="Striot.CompileIoT.html#test_subGraph2"><span class="hs-identifier">test_subGraph2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraph</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-identifier">t1</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span>
</span><a name="line-587"></a><a name="test_subGraph3"><a href="Striot.CompileIoT.html#test_subGraph3"><span class="hs-identifier">test_subGraph3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraph</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-identifier">t1</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Vertex</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><a name="t2"><a href="Striot.CompileIoT.html#t2"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Striot.CompileIoT.html#t1"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">]</span><span>
</span><a name="line-590"></a><a name="test_subGraph4"><a href="Striot.CompileIoT.html#test_subGraph4"><span class="hs-identifier">test_subGraph4</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraph</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-identifier">t2</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Vertex</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-591"></a><a name="test_subGraph5"><a href="Striot.CompileIoT.html#test_subGraph5"><span class="hs-identifier">test_subGraph5</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">subGraph</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-identifier">t2</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">]</span><span> </span><span class="hs-operator">+</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span class="hs-identifier">childrenOf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679325866"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-594"></a><span>              </span><a href="#local-6989586621679325866"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="#local-6989586621679325866"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679325866"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-595"></a><a name="childrenOf"><a href="Striot.CompileIoT.html#childrenOf"><span class="hs-identifier">childrenOf</span></a></a><span> </span><a name="local-6989586621679326240"><a href="#local-6989586621679326240"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><a href="#local-6989586621679326240"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">edgeList</span><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span class="hs-comment">-- | Given an existing partitioning and a new operator to consider: We can</span><span>
</span><a name="line-598"></a><span class="hs-comment">-- start a new partition; in some circumstances we can also append the operator</span><span>
</span><a name="line-599"></a><span class="hs-comment">-- to the last partition.</span><span>
</span><a name="line-600"></a><span class="hs-identifier">extendPartitioning</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-type">StreamVertex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-type">StreamVertex</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Striot.StreamGraph.html#StreamVertex"><span class="hs-identifier hs-type">StreamVertex</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-601"></a><a name="extendPartitioning"><a href="Striot.CompileIoT.html#extendPartitioning"><span class="hs-identifier">extendPartitioning</span></a></a><span> </span><a name="local-6989586621679326241"><a href="#local-6989586621679326241"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679326242"><a href="#local-6989586621679326242"><span class="hs-identifier">choice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-602"></a><span>  </span><a name="local-6989586621679326243"><a href="#local-6989586621679326243"><span class="hs-identifier">lastNode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679326242"><span class="hs-identifier hs-var">choice</span></a><span>
</span><a name="line-603"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="Striot.CompileIoT.html#singleton"><span class="hs-identifier hs-var">singleton</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679326241"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621679326242"><span class="hs-identifier hs-var">choice</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>     </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">operator</span><span> </span><a href="#local-6989586621679326243"><span class="hs-identifier hs-var">lastNode</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Striot.StreamGraph.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Striot.StreamGraph.html#isSource"><span class="hs-identifier hs-var">isSource</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">operator</span><span> </span><a href="#local-6989586621679326243"><span class="hs-identifier hs-var">lastNode</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>     </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679326242"><span class="hs-identifier hs-var">choice</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="#local-6989586621679326241"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-606"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679326242"><span class="hs-identifier hs-var">choice</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="#local-6989586621679326241"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-607"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">init</span><span> </span><a href="#local-6989586621679326242"><span class="hs-identifier hs-var">choice</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621679326242"><span class="hs-identifier hs-var">choice</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679326241"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-608"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><a name="singleton"><a href="Striot.CompileIoT.html#singleton"><span class="hs-identifier">singleton</span></a></a><span> </span><a name="local-6989586621679326244"><a href="#local-6989586621679326244"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">operator</span><span> </span><a href="#local-6989586621679326244"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Striot.StreamGraph.html#Sink"><span class="hs-identifier hs-var">Sink</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Striot.StreamGraph.html#isSource"><span class="hs-identifier hs-var">isSource</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">operator</span><span> </span><a href="#local-6989586621679326244"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><a name="g%27"><a href="Striot.CompileIoT.html#g%27"><span class="hs-identifier">g'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><span> </span><a href="Striot.CompileIoT.html#v0"><span class="hs-identifier hs-var">v0</span></a><span> </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v1"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v2"><span class="hs-identifier hs-var">v2</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-613"></a><a name="test_g%27"><a href="Striot.CompileIoT.html#test_g%27"><span class="hs-identifier">test_g'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-614"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-615"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-616"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.CompileIoT.html#allPartitions"><span class="hs-identifier hs-var">allPartitions</span></a><span> </span><a href="Striot.CompileIoT.html#g%27"><span class="hs-identifier hs-var">g'</span></a><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><a name="g2"><a href="Striot.CompileIoT.html#g2"><span class="hs-identifier">g2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">overlay</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#v0"><span class="hs-identifier hs-var">v0</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v4"><span class="hs-identifier hs-var">v4</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v2"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">path</span><span> </span><span class="hs-special">[</span><a href="Striot.CompileIoT.html#v3"><span class="hs-identifier hs-var">v3</span></a><span class="hs-special">,</span><span> </span><a href="Striot.CompileIoT.html#v4"><span class="hs-identifier hs-var">v4</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><a name="test_g2"><a href="Striot.CompileIoT.html#test_g2"><span class="hs-identifier">test_g2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-621"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-622"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.CompileIoT.html#allPartitions"><span class="hs-identifier hs-var">allPartitions</span></a><span> </span><a href="Striot.CompileIoT.html#g2"><span class="hs-identifier hs-var">g2</span></a><span>
</span><a name="line-623"></a><span>
</span><a name="line-624"></a><a name="test_g3"><a href="Striot.CompileIoT.html#test_g3"><span class="hs-identifier">test_g3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">assertEqual</span><span>
</span><a name="line-625"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">5</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-626"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">5</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-627"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">5</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-628"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">5</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-629"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">5</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-630"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">5</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-631"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">5</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-632"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-number">5</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-633"></a><span>    </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.CompileIoT.html#allPartitions"><span class="hs-identifier hs-var">allPartitions</span></a><span> </span><a href="Striot.CompileIoT.html#g3"><span class="hs-identifier hs-var">g3</span></a><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-636"></a><span class="hs-comment">-- Jackson/cost model entry point functions</span><span>
</span><a name="line-637"></a><span class="hs-comment">-- No partitioning</span><span>
</span><a name="line-638"></a><span>
</span><a name="line-639"></a><span class="hs-comment">-- | derive all optimisations of the supplied StreamGraph, calculate all</span><span>
</span><a name="line-640"></a><span class="hs-comment">-- Jackson stuff from that</span><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span class="hs-identifier">allOptimisations</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Striot.StreamGraph.html#StreamGraph"><span class="hs-identifier hs-type">StreamGraph</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Striot.Jackson.html#OperatorInfo"><span class="hs-identifier hs-type">OperatorInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-643"></a><a name="allOptimisations"><a href="Striot.CompileIoT.html#allOptimisations"><span class="hs-identifier">allOptimisations</span></a></a><span> </span><a name="local-6989586621679326245"><a href="#local-6989586621679326245"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-644"></a><span>    </span><a name="local-6989586621679326246"><a href="#local-6989586621679326246"><span class="hs-identifier">sgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Striot.LogicalOptimiser.html#applyRules"><span class="hs-identifier hs-var">applyRules</span></a><span> </span><span class="hs-number">5</span><span> </span><a href="#local-6989586621679326245"><span class="hs-identifier hs-var">sg</span></a><span>
</span><a name="line-645"></a><span>    </span><a name="local-6989586621679326247"><a href="#local-6989586621679326247"><span class="hs-identifier">out</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679326248"><a href="#local-6989586621679326248"><span class="hs-identifier">sg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679326248"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">,</span><span> </span><a href="Striot.Jackson.html#calcAllSg"><span class="hs-identifier hs-var">calcAllSg</span></a><span> </span><a href="#local-6989586621679326248"><span class="hs-identifier hs-var">sg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679326246"><span class="hs-identifier hs-var">sgs</span></a><span>
</span><a name="line-646"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679326247"><span class="hs-identifier hs-var">out</span></a><span>
</span><a name="line-647"></a></pre></body></html>